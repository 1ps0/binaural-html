<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Binaural Beats & Healing Frequencies</title>
    
    <!-- Core Styles -->
    <style>
        /* Theme System - Base Tokens */
        :root {
            /* Base Colors - HSL for easier manipulation */
            --color-primary-h: 220;
            --color-primary-s: 100%;
            --color-primary-l: 62%;
            --color-secondary-h: 260;
            --color-secondary-s: 84%;
            --color-secondary-l: 57%;
            --color-success-h: 160;
            --color-success-s: 95%;
            --color-success-l: 43%;
            --color-danger-h: 358;
            --color-danger-s: 85%;
            --color-danger-l: 54%;

            /* Light Theme Defaults */
            --light-bg: hsl(0, 0%, 100%);
            --light-text: hsl(0, 0%, 20%);
            --light-card-bg: hsl(210, 17%, 98%);
            --light-card-border: hsl(210, 14%, 89%);
            --light-control-bg: hsla(0, 0%, 100%, 0.95);

            /* Dark Theme Values */
            --dark-bg: hsl(0, 0%, 10%);
            --dark-text: hsl(0, 0%, 90%);
            --dark-card-bg: hsl(0, 0%, 18%);
            --dark-card-border: hsl(0, 0%, 25%);
            --dark-control-bg: hsla(0, 0%, 10%, 0.95);

            /* Active Theme Values - Default to Light */
            --bg: var(--light-bg);
            --text: var(--light-text);
            --card-bg: var(--light-card-bg);
            --card-border: var(--light-card-border);
            --control-bg: var(--light-control-bg);
            
            /* Functional Colors */
            --primary: hsl(var(--color-primary-h), var(--color-primary-s), var(--color-primary-l));
            --secondary: hsl(var(--color-secondary-h), var(--color-secondary-s), var(--color-secondary-l));
            --success: hsl(var(--color-success-h), var(--color-success-s), var(--color-success-l));
            --danger: hsl(var(--color-danger-h), var(--color-danger-s), var(--color-danger-l));

            /* Spacing System */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;

            /* Typography */
            --font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            --font-size-base: 16px;
            --line-height-base: 1.5;

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 300ms ease;
            --transition-slow: 500ms ease;

            /* Z-index Layers */
            --z-control-bar: 1000;
            --z-modal: 2000;
            --z-tooltip: 3000;

            /* Add dark variants for hover states */
            --primary-dark: hsl(var(--color-primary-h), var(--color-primary-s), 52%);
            --success-dark: hsl(var(--color-success-h), var(--color-success-s), 33%);
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --bg: var(--dark-bg);
            --text: var(--dark-text);
            --card-bg: var(--dark-card-bg);
            --card-border: var(--dark-card-border);
            --control-bg: var(--dark-control-bg);
        }

        /* Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: var(--font-size-base);
            line-height: var(--line-height-base);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg);
            color: var(--text);
            transition: 
                background-color var(--transition-normal),
                color var(--transition-normal);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Layout */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-md);
        }

        /* Header */
        .app-header {
            background-color: var(--primary);
            color: white;
            padding: var(--space-lg) 0;
            box-shadow: 0 2px 4px hsla(0, 0%, 0%, 0.1);
        }

        .app-title {
            font-size: 2rem;
            margin: 0;
        }

        .app-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: var(--space-sm);
        }

        /* Header Actions */
        .app-header__actions {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-top: var(--space-md);
        }

        .theme-toggle-button,
        .view-toggle-button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            color: white;
            transition: all var(--transition-fast);
        }

        .theme-toggle-button:hover,
        .view-toggle-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* View Toggle Group */
        .view-toggle-group {
            display: flex;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            overflow: hidden;
        }

        .view-toggle-button {
            border: none;
            border-radius: 0;
            padding: 6px 8px;
        }

        .view-toggle-button:first-child {
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }

        .view-toggle-button.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .view-toggle-button svg {
            display: block;
            width: 20px;
            height: 20px;
            fill: none;
            stroke: currentColor;
        }

        .theme-toggle-icon {
            font-size: 1.2rem;
        }

        /* Control Bar */
        .control-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--control-bg);
            padding: var(--space-md);
            box-shadow: 0 -2px 10px hsla(0, 0%, 0%, 0.1);
            z-index: var(--z-control-bar);
            transition: transform var(--transition-normal);
        }

        .control-bar .container {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        .control-bar.minimized {
            transform: translateY(calc(100% - 40px));
        }

        .control-bar.top {
            top: 0;
            bottom: auto;
            box-shadow: 0 2px 10px hsla(0, 0%, 0%, 0.1);
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: var(--space-xl) 0;
            margin-bottom: 100px; /* Space for control bar */
        }

        /* Utility Classes */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Frequency Cards & Lists */
        .frequency-section {
            margin-bottom: var(--space-xl);
        }

        .frequency-section__header {
            margin-bottom: var(--space-lg);
        }

        .frequency-section__title {
            font-size: 1.5rem;
            color: var(--text);
            margin: 0 0 var(--space-sm);
        }

        .frequency-section__description {
            color: var(--text);
            opacity: 0.8;
            margin: 0;
        }

        /* Card View */
        .frequency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-md);
        }

        .frequency-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .frequency-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .frequency-card__header {
            padding: var(--space-md);
            position: relative;
            border-bottom: 1px solid var(--card-border);
        }

        .frequency-card__title {
            font-size: 1.2rem;
            margin: 0;
            padding-right: 80px; /* Space for frequency badge */
            color: var(--text);
        }

        .frequency-card__frequency {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            background: var(--bg);
            color: var(--text);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .frequency-card__body {
            padding: var(--space-md);
        }

        .frequency-card__description {
            margin: 0 0 var(--space-md);
            color: var(--text);
            opacity: 0.8;
            font-size: 0.95rem;
        }

        .frequency-card__warning {
            margin: var(--space-sm) 0;
            padding: var(--space-sm);
            background: var(--warning);
            color: var(--dark);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .frequency-card__actions {
            display: flex;
            gap: 0;
            margin: var(--space-md) calc(var(--space-md) * -1) calc(var(--space-md) * -1);
            border-top: 1px solid var(--card-border);
        }

        .frequency-card .btn {
            flex: 1;
            border-radius: 0;
            padding: var(--space-md);
            justify-content: center;
        }

        .frequency-card .btn:first-child {
            border-right: 1px solid var(--card-border);
        }

        /* List View */
        .frequency-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .frequency-item {
            display: grid;
            grid-template-columns: minmax(150px, 180px) minmax(0, 1fr) auto;
            gap: 0;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            overflow: hidden;
            transition: background-color var(--transition-fast);
        }

        .frequency-item:hover {
            background: var(--bg);
        }

        .frequency-item__header {
            padding: var(--space-md);
            background: var(--card-bg);
            border-right: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
            justify-content: center;
        }

        .frequency-item__title {
            font-size: 1rem;
            margin: 0;
            color: var(--text);
        }

        .frequency-item__frequency {
            font-size: 0.9rem;
            color: var(--text);
            opacity: 0.8;
            font-variant-numeric: tabular-nums;
            font-family: var(--font-family-mono, monospace);
            background: var(--bg);
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
            border: 1px solid var(--card-border);
        }

        .frequency-item__body {
            padding: var(--space-md);
            display: flex;
            align-items: center;
            min-width: 0;
        }

        .frequency-item__description {
            margin: 0;
            color: var(--text);
            opacity: 0.8;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .frequency-item__actions {
            display: flex;
            align-items: stretch;
            gap: 0;
            padding: 0;
            min-width: 120px;
            border-left: 1px solid var(--card-border);
        }

        .frequency-item .btn {
            flex: 1;
            border-radius: 0;
            padding: var(--space-md);
            justify-content: center;
        }

        .frequency-item .btn:first-child {
            border-right: 1px solid var(--card-border);
        }

        .frequency-item .category-badge {
            margin-top: 2px;
            font-size: 0.8rem;
            padding: 2px 8px;
            background: var(--bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            color: var(--text);
            opacity: 0.8;
            display: inline-block;
            max-width: fit-content;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--primary);
            color: white;
        }

        .btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn--icon {
            padding: 8px;
            border-radius: 50%;
        }

        .btn--play {
            min-width: 100px;
        }

        .btn--play.playing {
            background: var(--success);
        }

        .btn--pin {
            background: transparent;
            border: 1px solid var(--card-border);
            color: var(--text);
        }

        .btn--pin:hover {
            background: var(--card-bg);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn--pin.pinned {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Category Badges */
        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            background: var(--card-bg);
            color: var(--text);
            opacity: 0.8;
        }

        /* Type-specific styles */
        .frequency-card[data-type="binaural"],
        .frequency-item[data-type="binaural"] {
            --type-color: var(--primary);
        }

        .frequency-card[data-type="solfeggio"],
        .frequency-item[data-type="solfeggio"] {
            --type-color: var(--secondary);
        }

        .frequency-card[data-type="special"],
        .frequency-item[data-type="special"] {
            --type-color: var(--success);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .frequency-grid {
                grid-template-columns: 1fr;
            }

            .frequency-item {
                grid-template-columns: 120px minmax(0, 1fr) auto;
            }

            .frequency-item__actions {
                min-width: 100px;
            }

            .btn--play {
                min-width: 80px;
                padding: 8px;
            }

            .control-bar {
                padding: var(--space-sm);
            }

            .control-bar .container {
                gap: var(--space-sm);
            }

            .control-bar__section {
                margin: 0;
            }

            /* Compact layout for mobile */
            .control-bar__volume {
                flex: 0 0 auto;
            }

            .control-bar__view-toggle {
                flex: 0 0 auto;
            }

            .control-bar__search {
                flex: 1;
                min-width: 0;
            }

            .control-bar__actions {
                flex: 0 0 auto;
            }

            .volume-slider {
                width: 80px;
            }

            .volume-display {
                display: none;
            }

            .search-input {
                padding: 6px 28px 6px 8px;
                font-size: 0.85rem;
            }

            .action-button {
                padding: 6px 8px;
                font-size: 0.85rem;
            }

            .action-button svg {
                width: 14px;
                height: 14px;
            }

            /* Adjust spacing for active tones */
            .active-tones-container {
                gap: 4px;
                padding: 4px 0;
            }

            .active-tone {
                padding: 2px 6px 2px 8px;
                font-size: 0.85rem;
            }

            .active-tone__stop {
                width: 16px;
                height: 16px;
            }
        }

        @media (max-width: 576px) {
            .frequency-item {
                grid-template-columns: 100px minmax(0, 1fr) auto;
            }

            .frequency-item__actions {
                min-width: 90px;
                padding: 6px;
            }

            .btn {
                padding: 6px 10px;
                font-size: 0.85rem;
            }

            .control-bar {
                padding: var(--space-xs);
            }

            .control-bar .container {
                gap: var(--space-xs);
            }

            .volume-slider {
                width: 60px;
            }

            .btn {
                padding: 6px 10px;
                font-size: 0.85rem;
            }
        }

        /* Info Button */
        .btn--info {
            margin-top: var(--space-md);
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .btn--info:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Info Modal */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: var(--z-modal);
            padding: var(--space-md);
            overflow-y: auto;
        }

        .info-modal.visible {
            display: block;
        }

        .info-modal__content {
            background: var(--bg);
            max-width: 800px;
            margin: var(--space-xl) auto;
            padding: var(--space-xl);
            border-radius: 12px;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .info-modal__close {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text);
            cursor: pointer;
            padding: var(--space-sm);
            border-radius: 50%;
            line-height: 1;
            transition: all var(--transition-fast);
        }

        .info-modal__close:hover {
            background: var(--card-bg);
        }

        .info-modal h2 {
            margin: 0 0 var(--space-lg);
            color: var(--text);
        }

        .info-modal h3 {
            color: var(--text);
            margin: var(--space-lg) 0 var(--space-sm);
        }

        .info-modal p {
            color: var(--text);
            opacity: 0.9;
            line-height: 1.6;
        }

        .info-modal section {
            margin-bottom: var(--space-lg);
        }

        .info-modal ul, 
        .info-modal ol {
            color: var(--text);
            opacity: 0.9;
            line-height: 1.6;
            margin: var(--space-sm) 0;
            padding-left: var(--space-lg);
        }

        .info-modal li {
            margin: var(--space-xs) 0;
        }

        /* Theme Toggle */
        .theme-toggle-button {
            background: none;
            border: 1px solid var(--card-border);
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            color: var(--text);
            transition: all var(--transition-fast);
        }

        .theme-toggle-button:hover {
            background: var(--card-bg);
            border-color: var(--primary);
        }

        .theme-toggle-icon {
            font-size: 1.2rem;
        }

        /* Fix play/pause button hover states */
        .btn--play:hover {
            background: var(--primary-dark, hsl(220, 100%, 52%));
        }

        .btn--play.playing:hover {
            background: var(--success-dark, hsl(160, 95%, 33%));
        }

        /* Active Tones */
        .active-tones-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 32px;
        }

        .active-tone {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px 4px 12px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .active-tone--binaural { border-color: var(--primary); }
        .active-tone--solfeggio { border-color: var(--secondary); }
        .active-tone--special { border-color: var(--success); }

        .active-tone__name {
            font-weight: 500;
            color: var(--text);
        }

        .active-tone__freq {
            color: var(--text);
            opacity: 0.7;
            font-variant-numeric: tabular-nums;
        }

        .active-tone__stop {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            padding: 0;
            border: none;
            border-radius: 50%;
            background: var(--card-border);
            color: var(--text);
            font-size: 1rem;
            line-height: 1;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .active-tone__stop:hover {
            background: var(--danger);
            color: white;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .control-bar .container {
                flex-direction: column;
                align-items: stretch;
            }

            .control-bar__section {
                width: 100%;
            }

            .search-container {
                width: 100%;
            }

            .control-bar__actions {
                justify-content: space-between;
            }
        }

        .version-info {
            font-family: var(--font-family-mono, monospace);
            background: var(--card-bg);
            padding: var(--space-sm);
            border-radius: 6px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="container">
            <h1 class="app-title">Binaural Beats & Healing Frequencies</h1>
            <p class="app-subtitle">Brainwave Entrainment, Solfeggio Tones & Sound Therapy</p>
            <div class="app-header__actions">
                <button class="theme-toggle-button" id="themeToggle" aria-label="Toggle theme">
                    <span class="theme-toggle-icon">🌓</span>
                </button>
                <div class="view-toggle-group">
                    <button class="view-toggle-button ${AppState.ui.view === 'cards' ? 'active' : ''}" data-view="cards">
                        <svg class="icon" viewBox="0 0 24 24" width="24" height="24">
                            <rect x="3" y="3" width="7" height="7" rx="1"/>
                            <rect x="14" y="3" width="7" height="7" rx="1"/>
                            <rect x="3" y="14" width="7" height="7" rx="1"/>
                            <rect x="14" y="14" width="7" height="7" rx="1"/>
                        </svg>
                        <span class="visually-hidden">Card View</span>
                    </button>
                    <button class="view-toggle-button ${AppState.ui.view === 'list' ? 'active' : ''}" data-view="list">
                        <svg class="icon" viewBox="0 0 24 24" width="24" height="24">
                            <line x1="3" y1="6" x2="21" y2="6" stroke-width="2"/>
                            <line x1="3" y1="12" x2="21" y2="12" stroke-width="2"/>
                            <line x1="3" y1="18" x2="21" y2="18" stroke-width="2"/>
                        </svg>
                        <span class="visually-hidden">List View</span>
                    </button>
                </div>
                <button class="btn btn--info" id="showInfo">ℹ️ About Sound Frequencies</button>
            </div>
        </div>
    </header>

    <div class="info-modal" id="infoModal">
        <div class="info-modal__content">
            <button class="info-modal__close" id="closeInfo">×</button>
            <h2>About Therapeutic Frequencies</h2>
            <section>
                <h3>What are Binaural Beats?</h3>
                <p>Binaural beats are created when slightly different frequencies are played in each ear. Your brain perceives the difference between these frequencies as a beat, which can help entrain your brainwaves to specific states.</p>
            </section>
            <section>
                <h3>What are Solfeggio Frequencies?</h3>
                <p>Solfeggio frequencies are a set of ancient musical tones said to have various healing properties. These frequencies were traditionally used in sacred music and are believed to affect different aspects of well-being.</p>
            </section>
            <section>
                <h3>How Therapeutic Frequencies Work</h3>
                <p>Different frequencies affect your brain and body in unique ways. These scientifically-studied frequencies can help create optimal mental states for different activities:</p>
                <ul>
                    <li><strong>Focus & Productivity:</strong> Beta and Gamma frequencies help sharpen attention and enhance cognitive performance</li>
                    <li><strong>Meditation & Mindfulness:</strong> Theta frequencies facilitate deep meditative states and creative flow</li>
                    <li><strong>Sleep & Recovery:</strong> Delta frequencies support restorative sleep and physical healing</li>
                    <li><strong>Relaxation & Calm:</strong> Alpha frequencies promote relaxation while maintaining alertness</li>
                    <li><strong>Healing & Wellbeing:</strong> Solfeggio and special frequencies traditionally associated with physical and emotional healing</li>
                </ul>
            </section>
            <section>
                <h3>Getting the Best Results</h3>
                <ol>
                    <li>Use quality headphones for binaural beats to work effectively</li>
                    <li>Start with shorter sessions (15-30 minutes) and observe how you respond</li>
                    <li>Choose frequencies based on your current needs and desired state</li>
                    <li>Keep volume at a comfortable level - louder isn't better</li>
                    <li>Create favorites lists for different activities using the pin feature</li>
                </ol>
            </section>
            <section>
                <h3>Important Notes</h3>
                <ul>
                    <li>Always use comfortable volume levels</li>
                    <li>If you experience any discomfort, stop using immediately</li>
                    <li>This is not a substitute for medical treatment</li>
                    <li>Some frequencies may be below human hearing range but can still have effects</li>
                </ul>
            </section>
            <section>
                <h3>Open Source</h3>
                <p>This project is open source and available on GitHub. Feel free to contribute or report issues:</p>
                <p><a href="https://github.com/1ps0/binaural" target="_blank" rel="noopener noreferrer" style="color: var(--primary);">github.com/1ps0/binaural</a></p>
                <p>You can also run this app locally:</p>
                <ul>
                    <li><strong>Desktop:</strong> Simply drag index.html into Chrome/Edge</li>
                    <li><strong>iOS:</strong> Save to Files app and open with Safari</li>
                    <li><strong>Android:</strong> Open with Chrome from Downloads</li>
                </ul>
                <p>See the README for detailed setup instructions.</p>
            </section>
            <section>
                <h3>Version Information</h3>
                <p class="version-info">
                    Version: 4.1.0<br>
                    Build: 20250303.1<br>
                    Last Updated: March 3, 2025
                </p>
            </section>
        </div>
    </div>

    <main class="main-content">
        <div class="container">
            <div class="frequency-sections">
                <!-- Sections will be dynamically populated -->
            </div>
        </div>
    </main>

    <div class="control-bar">
        <div class="container">
            <!-- Controls will be dynamically populated -->
        </div>
    </div>

    <!-- Core Systems -->
    <script>
        // State Management System
        const AppState = {
            audio: {
                context: null,
                oscillators: {},
                gainNodes: {},
                masterGain: null,
                volume: 0.2,
                isReady: false
            },
            ui: {
                theme: localStorage.getItem('theme') || 'light',
                view: localStorage.getItem('view') || 'list',
                controlBar: {
                    position: localStorage.getItem('controlBarPosition') || 'bottom',
                    minimized: false
                }
            },
            frequencies: {
                active: [],
                pinned: {
                    focus: [],
                    meditation: [],
                    sleep: [],
                    relaxation: [],
                    healing: []
                },
                filter: ''
            }
        };

        // Event System
        const EventSystem = {
            handlers: {},
            
            on(event, handler) {
                if (!this.handlers[event]) {
                    this.handlers[event] = [];
                }
                this.handlers[event].push(handler);
                return () => this.off(event, handler); // Return cleanup function
            },
            
            off(event, handler) {
                if (this.handlers[event]) {
                    this.handlers[event] = this.handlers[event].filter(h => h !== handler);
                }
            },
            
            emit(event, data) {
                if (this.handlers[event]) {
                    this.handlers[event].forEach(handler => {
                        try {
                            handler(data);
                        } catch (error) {
                            console.error(`Error in event handler for ${event}:`, error);
                        }
                    });
                }
            },

            once(event, handler) {
                const onceHandler = (data) => {
                    handler(data);
                    this.off(event, onceHandler);
                };
                return this.on(event, onceHandler);
            }
        };

        // Theme System
        const ThemeSystem = {
            init() {
                this.applyTheme(AppState.ui.theme);
                this.setupListeners();
            },

            applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                AppState.ui.theme = theme;
                localStorage.setItem('theme', theme);
                EventSystem.emit('themeChanged', theme);
            },

            toggleTheme() {
                const newTheme = AppState.ui.theme === 'light' ? 'dark' : 'light';
                this.applyTheme(newTheme);
            },

            setupListeners() {
                // Listen for system theme changes
                if (window.matchMedia) {
                    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                    mediaQuery.addListener((e) => {
                        if (!localStorage.getItem('theme')) {
                            this.applyTheme(e.matches ? 'dark' : 'light');
                        }
                    });
                }
            }
        };

        // Audio System
        const AudioSystem = {
            init() {
                // Only initialize if not already initialized
                if (!AppState.audio.context && window.AudioContext) {
                    try {
                        return this.initializeAudioContext();
                    } catch (error) {
                        console.error('Failed to initialize audio context:', error);
                        EventSystem.emit('audioError', { 
                            message: 'Failed to initialize audio system. Please ensure your browser supports Web Audio API.', 
                            error 
                        });
                        return false;
                    }
                }
                return AppState.audio.isReady;
            },

            initializeAudioContext() {
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    const context = new AudioContext();
                    
                    if (!context || typeof context.createGain !== 'function') {
                        throw new Error('Invalid Audio Context');
                    }
                    
                    AppState.audio.context = context;
                    
                    const masterGain = context.createGain();
                    if (!masterGain) {
                        throw new Error('Failed to create gain node');
                    }
                    
                    AppState.audio.masterGain = masterGain;
                    AppState.audio.masterGain.gain.value = AppState.audio.volume;
                    AppState.audio.masterGain.connect(AppState.audio.context.destination);
                    
                    // If context is suspended (common in some browsers), try to resume it
                    if (context.state === 'suspended') {
                        context.resume().catch(error => {
                            console.warn('Could not resume audio context:', error);
                        });
                    }
                    
                    AppState.audio.isReady = true;
                    EventSystem.emit('audioReady');
                    return true;
                } catch (error) {
                    console.error('Error initializing audio context:', error);
                    return false;
                }
            },

            createOscillator(frequency, type = 'sine') {
                try {
                    const oscillator = AppState.audio.context.createOscillator();
                    const gainNode = AppState.audio.context.createGain();
                    
                    oscillator.type = type;
                    oscillator.frequency.value = frequency;
                    
                    // Start with zero gain to prevent clicks
                    gainNode.gain.value = 0;
                    
                    // Connect nodes
                    oscillator.connect(gainNode);
                    gainNode.connect(AppState.audio.masterGain);
                    
                    return { oscillator, gainNode };
                } catch (error) {
                    console.error('Error creating oscillator:', error);
                    EventSystem.emit('audioError', { message: 'Failed to create oscillator', error });
                    return null;
                }
            },

            createBinauralBeat(frequency, carrierFrequency = 200) {
                try {
                    // Create merger for stereo output
                    const merger = AppState.audio.context.createChannelMerger(2);
                    
                    // Create oscillators for left and right ears
                    const leftOsc = this.createOscillator(carrierFrequency);
                    const rightOsc = this.createOscillator(carrierFrequency + frequency);
                    
                    if (!leftOsc || !rightOsc) return null;
                    
                    // Reconnect to merger instead of master gain
                    leftOsc.gainNode.disconnect();
                    rightOsc.gainNode.disconnect();
                    leftOsc.gainNode.connect(merger, 0, 0);  // Left channel
                    rightOsc.gainNode.connect(merger, 0, 1); // Right channel
                    merger.connect(AppState.audio.masterGain);
                    
                    return {
                        left: leftOsc,
                        right: rightOsc,
                        merger
                    };
                } catch (error) {
                    console.error('Error creating binaural beat:', error);
                    EventSystem.emit('audioError', { message: 'Failed to create binaural beat', error });
                    return null;
                }
            },

            startTone(id, frequency, options = {}) {
                const {
                    type = 'sine',
                    isBinaural = false,
                    carrierFrequency = 200,
                    volume = AppState.audio.volume
                } = options;

                try {
                    // Ensure audio context is initialized and resumed
                    if (!this.init()) {
                        EventSystem.emit('audioError', { message: 'Audio system not ready. Please try again.' });
                        return false;
                    }

                    // Resume audio context if it's in suspended state
                    if (AppState.audio.context.state === 'suspended') {
                        AppState.audio.context.resume();
                    }
                    
                    // Stop any existing tone with this ID
                    this.stopTone(id);
                    
                    let nodes;
                    if (isBinaural) {
                        nodes = this.createBinauralBeat(frequency, carrierFrequency);
                        if (nodes) {
                            nodes.left.oscillator.start();
                            nodes.right.oscillator.start();
                            // Ramp up gain smoothly
                            this.rampGain(nodes.left.gainNode.gain, volume);
                            this.rampGain(nodes.right.gainNode.gain, volume);
                            AppState.audio.oscillators[id] = nodes;
                        }
                    } else {
                        nodes = this.createOscillator(frequency, type);
                        if (nodes) {
                            nodes.oscillator.start();
                            this.rampGain(nodes.gainNode.gain, volume);
                            AppState.audio.oscillators[id] = nodes;
                        }
                    }

                    if (nodes) {
                        EventSystem.emit('toneStarted', { id, frequency, isBinaural });
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error starting tone:', error);
                    EventSystem.emit('audioError', { message: 'Failed to start tone', error });
                    return false;
                }
            },

            stopTone(id) {
                try {
                    const nodes = AppState.audio.oscillators[id];
                    if (!nodes) return false;

                    const cleanup = () => {
                        if (nodes.merger) nodes.merger.disconnect();
                        delete AppState.audio.oscillators[id];
                        EventSystem.emit('toneStopped', { id });
                    };

                    if (nodes.left && nodes.right) {
                        // Binaural beat
                        this.rampGain(nodes.left.gainNode.gain, 0).then(() => {
                            nodes.left.oscillator.stop();
                            nodes.right.oscillator.stop();
                            cleanup();
                        });
                    } else {
                        // Single tone
                        this.rampGain(nodes.gainNode.gain, 0).then(() => {
                            nodes.oscillator.stop();
                            cleanup();
                        });
                    }
                    return true;
                } catch (error) {
                    console.error('Error stopping tone:', error);
                    EventSystem.emit('audioError', { message: 'Failed to stop tone', error });
                    return false;
                }
            },

            stopAll() {
                try {
                    const activeIds = Object.keys(AppState.audio.oscillators);
                    
                    // Immediately stop and disconnect all oscillators
                    activeIds.forEach(id => {
                        const nodes = AppState.audio.oscillators[id];
                        if (!nodes) return;

                        try {
                            if (nodes.left && nodes.right) {
                                // Binaural beat cleanup
                                nodes.left.oscillator.stop();
                                nodes.right.oscillator.stop();
                                nodes.left.gainNode.disconnect();
                                nodes.right.gainNode.disconnect();
                                if (nodes.merger) nodes.merger.disconnect();
                            } else if (nodes.oscillator) {
                                // Single tone cleanup
                                nodes.oscillator.stop();
                                nodes.gainNode.disconnect();
                            }

                            // Update play button state
                            const playButton = document.querySelector(`.btn--play[data-id="${id}"]`);
                            if (playButton) {
                                playButton.classList.remove('playing');
                                playButton.innerHTML = `<span class="visually-hidden">Play</span>▶`;
                            }
                        } catch (err) {
                            console.warn(`Error cleaning up oscillator ${id}:`, err);
                        }
                    });

                    // Reset oscillators state
                    AppState.audio.oscillators = {};
                    
                    // Clear active tones container
                    const activeTones = document.querySelector('.active-tones-container');
                    if (activeTones) {
                        activeTones.innerHTML = '';
                    }

                    EventSystem.emit('allTonesStopped');
                } catch (error) {
                    console.error('Error in stopAll:', error);
                    // Force reset state even if cleanup fails
                    AppState.audio.oscillators = {};
                    EventSystem.emit('allTonesStopped');
                }
            },

            setVolume(value) {
                try {
                    const newVolume = Math.max(0, Math.min(1, value));
                    AppState.audio.volume = newVolume;
                    
                    if (AppState.audio.masterGain) {
                        this.rampGain(AppState.audio.masterGain.gain, newVolume);
                    }
                    
                    EventSystem.emit('volumeChanged', newVolume);
                    return true;
                } catch (error) {
                    console.error('Error setting volume:', error);
                    EventSystem.emit('audioError', { message: 'Failed to set volume', error });
                    return false;
                }
            },

            async rampGain(gainParam, targetValue, duration = 0.05) {
                const now = AppState.audio.context.currentTime;
                gainParam.cancelScheduledValues(now);
                gainParam.setValueAtTime(gainParam.value, now);
                gainParam.linearRampToValueAtTime(targetValue, now + duration);
                return new Promise(resolve => setTimeout(resolve, duration * 1000));
            },

            // Utility method to check if a frequency is audible
            isAudible(frequency) {
                return frequency >= 20 && frequency <= 20000;
            },

            // Utility method to format frequency for display
            formatFrequency(frequency) {
                return `${parseFloat(frequency).toFixed(2)} Hz`;
            }
        };

        // Frequency Data System
        const FrequencySystem = {
            // Core frequency data
            data: {
                focus: [
                    {
                        id: 'deep-focus-40hz',
                        title: 'Deep Focus',
                        frequency: 40,
                        type: 'binaural',
                        category: 'gamma',
                        carrierFrequency: 200,
                        description: 'Enhance mental clarity and focus with gamma waves. Ideal for complex tasks, studying, or when you need peak cognitive performance.',
                        warning: null
                    },
                    {
                        id: 'flow-state-15hz',
                        title: 'Flow State',
                        frequency: 15,
                        type: 'binaural',
                        category: 'beta',
                        carrierFrequency: 200,
                        description: 'Enter a state of focused productivity. Perfect for sustained attention, problem-solving, and getting in the zone.',
                        warning: null
                    }
                ],
                meditation: [
                    {
                        id: 'deep-meditation-6hz',
                        title: 'Deep Meditation',
                        frequency: 6,
                        type: 'binaural',
                        category: 'theta',
                        carrierFrequency: 200,
                        description: 'Access profound meditative states easily. Helps quiet mental chatter and access deeper awareness.',
                        warning: null
                    },
                    {
                        id: 'creative-insight-4.5hz',
                        title: 'Creative Insight',
                        frequency: 4.5,
                        type: 'binaural',
                        category: 'theta',
                        carrierFrequency: 200,
                        description: 'Unlock creative inspiration and intuitive insights. Perfect for brainstorming, artistic work, or problem-solving.',
                        warning: null
                    },
                    {
                        id: 'mindful-presence-7.83hz',
                        title: 'Earth Resonance',
                        frequency: 7.83,
                        type: 'special',
                        category: 'earth',
                        description: "Align with Earth's natural frequency for grounding and balance. Helps reduce stress and restore natural rhythms.",
                        warning: 'This subtle frequency works through resonance rather than direct hearing.'
                    }
                ],
                sleep: [
                    {
                        id: 'deep-sleep-2hz',
                        title: 'Sleep Sanctuary',
                        frequency: 2,
                        type: 'binaural',
                        category: 'delta',
                        carrierFrequency: 200,
                        description: 'Guide your brain into deep, restorative sleep patterns. Ideal for overcoming insomnia or enhancing sleep quality.',
                        warning: null
                    },
                    {
                        id: 'twilight-3.5hz',
                        title: 'Twilight Transition',
                        frequency: 3.5,
                        type: 'binaural',
                        category: 'delta',
                        carrierFrequency: 200,
                        description: 'Ease the transition from wakefulness to sleep. Perfect for power naps or preparing for deep rest.',
                        warning: null
                    }
                ],
                relaxation: [
                    {
                        id: 'calm-clarity-10hz',
                        title: 'Calm Clarity',
                        frequency: 10,
                        type: 'binaural',
                        category: 'alpha',
                        carrierFrequency: 200,
                        description: 'Find your center with alert relaxation. Ideal for reading, light meditation, or unwinding while staying present.',
                        warning: null
                    },
                    {
                        id: 'stress-relief-432hz',
                        title: 'Harmonic Balance',
                        frequency: 432,
                        type: 'solfeggio',
                        category: 'healing',
                        description: 'Experience natural harmony and deep relaxation. Many find this frequency more pleasing than standard tuning.',
                        warning: null
                    }
                ],
                healing: [
                    {
                        id: 'cellular-harmony-528hz',
                        title: 'DNA Harmony',
                        frequency: 528,
                        type: 'solfeggio',
                        category: 'healing',
                        description: 'Known as the "miracle tone" for its potential cellular healing effects. Associated with transformation and repair.',
                        warning: null
                    },
                    {
                        id: 'pain-relief-174hz',
                        title: 'Gentle Relief',
                        frequency: 174,
                        type: 'special',
                        category: 'healing',
                        description: 'Natural frequency associated with pain reduction and muscle relaxation. Helps ease physical tension.',
                        warning: null
                    },
                    {
                        id: 'emotional-release-396hz',
                        title: 'Emotional Freedom',
                        frequency: 396,
                        type: 'solfeggio',
                        category: 'healing',
                        description: 'Release emotional blockages and transform guilt into joy. Supports liberation from limiting patterns.',
                        warning: null
                    },
                    {
                        id: 'spiritual-connection-963hz',
                        title: 'Crown Connection',
                        frequency: 963,
                        type: 'solfeggio',
                        category: 'healing',
                        description: 'Connect with higher awareness and spiritual insight. Creates a sense of oneness and transcendent peace.',
                        warning: null
                    }
                ]
            },

            init() {
                this.loadPinnedFrequencies();
                this.setupListeners();
            },

            setupListeners() {
                EventSystem.on('frequencyPinned', ({ id, type }) => {
                    this.pinFrequency(id, type);
                    UISystem.render();
                });

                EventSystem.on('frequencyUnpinned', ({ id, type }) => {
                    this.unpinFrequency(id, type);
                    UISystem.render();
                });
            },

            // Get all frequencies of a specific type
            getFrequencies(type) {
                return this.data[type] || [];
            },

            // Get a specific frequency by ID and type
            getFrequency(id, type) {
                // Search in all categories since type might be the underlying type (binaural, solfeggio, special)
                for (const category of Object.keys(this.data)) {
                    const found = this.data[category].find(f => f.id === id);
                    if (found) return found;
                }
                return null;
            },

            // Search frequencies across all types
            searchFrequencies(query) {
                query = query.toLowerCase().trim();
                const results = [];
                
                Object.keys(this.data).forEach(type => {
                    this.data[type].forEach(freq => {
                        if (
                            freq.title.toLowerCase().includes(query) ||
                            freq.description.toLowerCase().includes(query) ||
                            freq.frequency.toString().includes(query)
                        ) {
                            results.push(freq);
                        }
                    });
                });
                
                return results;
            },

            // Pin management
            pinFrequency(id, type) {
                const freq = this.getFrequency(id);
                if (!freq) return false;

                // Find which category this frequency belongs to
                let category;
                for (const [cat, freqs] of Object.entries(this.data)) {
                    if (freqs.find(f => f.id === id)) {
                        category = cat;
                        break;
                    }
                }

                if (category && !AppState.frequencies.pinned[category].includes(id)) {
                    AppState.frequencies.pinned[category].push(id);
                    this.savePinnedFrequencies();
                    EventSystem.emit('pinsUpdated', AppState.frequencies.pinned);
                    return true;
                }
                return false;
            },

            unpinFrequency(id, type) {
                // Find which category this frequency belongs to
                let category;
                for (const [cat, freqs] of Object.entries(this.data)) {
                    if (freqs.find(f => f.id === id)) {
                        category = cat;
                        break;
                    }
                }

                if (category) {
                    const index = AppState.frequencies.pinned[category].indexOf(id);
                    if (index > -1) {
                        AppState.frequencies.pinned[category].splice(index, 1);
                        this.savePinnedFrequencies();
                        EventSystem.emit('pinsUpdated', AppState.frequencies.pinned);
                        return true;
                    }
                }
                return false;
            },

            unpinAll() {
                Object.keys(AppState.frequencies.pinned).forEach(type => {
                    AppState.frequencies.pinned[type] = [];
                });
                this.savePinnedFrequencies();
                EventSystem.emit('pinsUpdated', AppState.frequencies.pinned);
            },

            // Get all pinned frequencies as full objects
            getPinnedFrequencies() {
                const pinned = {};
                Object.keys(AppState.frequencies.pinned).forEach(category => {
                    pinned[category] = AppState.frequencies.pinned[category]
                        .map(id => this.getFrequency(id))
                        .filter(Boolean);
                });
                return pinned;
            },

            // Local storage management
            savePinnedFrequencies() {
                localStorage.setItem('pinnedFrequencies', JSON.stringify(AppState.frequencies.pinned));
            },

            loadPinnedFrequencies() {
                try {
                    const saved = localStorage.getItem('pinnedFrequencies');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        // Validate the structure
                        if (typeof parsed === 'object' && parsed !== null) {
                            // Handle migration from old format if necessary
                            if (parsed.binaural || parsed.solfeggio || parsed.special) {
                                AppState.frequencies.pinned = {
                                    focus: [],
                                    meditation: [],
                                    sleep: [],
                                    relaxation: [],
                                    healing: []
                                };
                            } else {
                                AppState.frequencies.pinned = {
                                    focus: Array.isArray(parsed.focus) ? parsed.focus : [],
                                    meditation: Array.isArray(parsed.meditation) ? parsed.meditation : [],
                                    sleep: Array.isArray(parsed.sleep) ? parsed.sleep : [],
                                    relaxation: Array.isArray(parsed.relaxation) ? parsed.relaxation : [],
                                    healing: Array.isArray(parsed.healing) ? parsed.healing : []
                                };
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading pinned frequencies:', error);
                    // Reset to default state
                    AppState.frequencies.pinned = {
                        focus: [],
                        meditation: [],
                        sleep: [],
                        relaxation: [],
                        healing: []
                    };
                }
            },

            // Utility methods
            getCategoryInfo(category) {
                const categories = {
                    delta: { name: 'Delta', range: '0.5-4 Hz', description: 'Deep sleep, healing' },
                    theta: { name: 'Theta', range: '4-8 Hz', description: 'Meditation, creativity' },
                    alpha: { name: 'Alpha', range: '8-14 Hz', description: 'Relaxation, learning' },
                    beta: { name: 'Beta', range: '14-30 Hz', description: 'Focus, alertness' },
                    gamma: { name: 'Gamma', range: '30-100 Hz', description: 'Cognitive enhancement' },
                    healing: { name: 'Healing', range: 'Various', description: 'Traditional healing frequencies' },
                    earth: { name: 'Earth', range: 'Various', description: 'Natural Earth frequencies' }
                };
                return categories[category] || null;
            },

            getSectionDescription(type) {
                const descriptions = {
                    focus: 'Enhance concentration, mental clarity, and cognitive performance for your most important work.',
                    meditation: 'Access deeper states of awareness, creativity, and inner peace with these consciousness-expanding frequencies.',
                    sleep: 'Improve your sleep quality with frequencies that guide your brain into natural sleep patterns.',
                    relaxation: 'Find balance between relaxation and alertness, perfect for unwinding while staying present.',
                    healing: 'Traditional frequencies associated with physical, emotional, and spiritual wellbeing.'
                };
                return descriptions[type] || '';
            }
        };

        // UI Components System
        const UISystem = {
            init() {
                this.initializeControlBar();
                this.setupEventListeners();
                this.render();
            },

            initializeControlBar() {
                const controlBar = document.querySelector('.control-bar');
                const container = controlBar.querySelector('.container');
                
                // Create control bar components
                container.innerHTML = `
                    <div class="control-bar__section control-bar__volume">
                        <label for="volume" class="visually-hidden">Volume</label>
                        <input type="range" 
                            id="volume" 
                            class="volume-slider" 
                            min="0" 
                            max="1" 
                            step="0.01" 
                            value="${AppState.audio.volume}">
                        <span class="volume-display">${Math.round(AppState.audio.volume * 100)}%</span>
                    </div>

                    <div class="control-bar__section control-bar__search">
                        <div class="search-container">
                            <input type="text" 
                                id="frequency-search" 
                                class="search-input" 
                                placeholder="Search frequencies..."
                                value="${AppState.frequencies.filter}">
                            <button class="search-clear ${AppState.frequencies.filter ? 'visible' : ''}" aria-label="Clear search">
                                ×
                            </button>
                        </div>
                    </div>

                    <div class="control-bar__section control-bar__actions">
                        <button class="action-button stop-all" disabled>
                            <svg class="icon" viewBox="0 0 24 24" width="24" height="24">
                                <rect x="6" y="6" width="12" height="12"/>
                            </svg>
                            Stop All
                        </button>
                        <button class="action-button unpin-all" disabled>
                            <svg class="icon" viewBox="0 0 24 24" width="24" height="24">
                                <path d="M12 2L2 12l10 10 10-10z"/>
                            </svg>
                            Unpin All
                        </button>
                    </div>

                    <div class="control-bar__section control-bar__active-tones">
                        <div class="active-tones-container">
                            <!-- Active tones will be rendered here -->
                        </div>
                    </div>
                `;

                // Add new styles for control bar components
                const style = document.createElement('style');
                style.textContent = `
                    /* Control Bar Layout */
                    .control-bar__section {
                        display: flex;
                        align-items: center;
                        gap: var(--space-sm);
                    }

                    .control-bar .container {
                        display: flex;
                        align-items: center;
                        gap: var(--space-md);
                        flex-wrap: wrap;
                    }

                    /* Volume Control */
                    .volume-slider {
                        width: 100px;
                        height: 6px;
                        -webkit-appearance: none;
                        background: var(--card-border);
                        border-radius: 3px;
                        outline: none;
                    }

                    .volume-slider::-webkit-slider-thumb {
                        -webkit-appearance: none;
                        width: 16px;
                        height: 16px;
                        border-radius: 50%;
                        background: var(--primary);
                        cursor: pointer;
                        border: none;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                    }

                    .volume-display {
                        min-width: 3em;
                        text-align: right;
                        font-variant-numeric: tabular-nums;
                    }

                    /* Search */
                    .search-container {
                        position: relative;
                        flex: 1;
                        min-width: 200px;
                    }

                    .search-input {
                        width: 100%;
                        padding: 8px 32px 8px 12px;
                        border: 1px solid var(--card-border);
                        border-radius: 6px;
                        background: var(--bg);
                        color: var(--text);
                        font-size: 0.9rem;
                        transition: border-color var(--transition-fast);
                    }

                    .search-input:focus {
                        outline: none;
                        border-color: var(--primary);
                    }

                    .search-clear {
                        position: absolute;
                        right: 8px;
                        top: 50%;
                        transform: translateY(-50%);
                        background: none;
                        border: none;
                        color: var(--text);
                        font-size: 1.2rem;
                        cursor: pointer;
                        padding: 4px;
                        opacity: 0;
                        pointer-events: none;
                        transition: opacity var(--transition-fast);
                    }

                    .search-clear.visible {
                        opacity: 0.5;
                        pointer-events: auto;
                    }

                    .search-clear:hover {
                        opacity: 1;
                    }

                    /* Action Buttons */
                    .action-button {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        padding: 8px 12px;
                        border: none;
                        border-radius: 6px;
                        background: var(--primary);
                        color: white;
                        font-size: 0.9rem;
                        cursor: pointer;
                        transition: all var(--transition-fast);
                    }

                    .action-button:hover:not(:disabled) {
                        background: var(--primary-dark);
                    }

                    .action-button:disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                    }

                    .action-button svg {
                        width: 16px;
                        height: 16px;
                        fill: currentColor;
                    }

                    .action-button.stop-all {
                        background: var(--danger);
                    }

                    /* Active Tones */
                    .active-tones-container {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 8px;
                        min-height: 32px;
                    }

                    .active-tone {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 4px 8px 4px 12px;
                        background: var(--card-bg);
                        border: 1px solid var(--card-border);
                        border-radius: 20px;
                        font-size: 0.9rem;
                    }

                    .active-tone--binaural { border-color: var(--primary); }
                    .active-tone--solfeggio { border-color: var(--secondary); }
                    .active-tone--special { border-color: var(--success); }

                    .active-tone__name {
                        font-weight: 500;
                        color: var(--text);
                    }

                    .active-tone__freq {
                        color: var(--text);
                        opacity: 0.7;
                        font-variant-numeric: tabular-nums;
                    }

                    .active-tone__stop {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 20px;
                        height: 20px;
                        padding: 0;
                        border: none;
                        border-radius: 50%;
                        background: var(--card-border);
                        color: var(--text);
                        font-size: 1rem;
                        line-height: 1;
                        cursor: pointer;
                        transition: all var(--transition-fast);
                    }

                    .active-tone__stop:hover {
                        background: var(--danger);
                        color: white;
                    }
                `;
                document.head.appendChild(style);
            },

            setupEventListeners() {
                // Volume control
                const volumeSlider = document.getElementById('volume');
                volumeSlider.addEventListener('input', (e) => {
                    AudioSystem.setVolume(parseFloat(e.target.value));
                });

                // Search
                const searchInput = document.getElementById('frequency-search');
                const searchClear = document.querySelector('.search-clear');
                
                searchInput.addEventListener('input', (e) => {
                    const value = e.target.value;
                    AppState.frequencies.filter = value;
                    searchClear.classList.toggle('visible', value.length > 0);
                    this.render();
                });

                searchClear.addEventListener('click', () => {
                    searchInput.value = '';
                    AppState.frequencies.filter = '';
                    searchClear.classList.remove('visible');
                    this.render();
                });

                // Action buttons
                const stopAllButton = document.querySelector('.action-button.stop-all');
                stopAllButton.addEventListener('click', () => {
                    AudioSystem.stopAll();
                });

                const unpinAllButton = document.querySelector('.action-button.unpin-all');
                unpinAllButton.addEventListener('click', () => {
                    FrequencySystem.unpinAll();
                });

                // Event subscriptions
                EventSystem.on('toneStarted', () => this.updateControlState());
                EventSystem.on('toneStopped', () => this.updateControlState());
                EventSystem.on('pinsUpdated', () => this.updateControlState());
                EventSystem.on('volumeChanged', (volume) => {
                    volumeSlider.value = volume;
                    document.querySelector('.volume-display').textContent = `${Math.round(volume * 100)}%`;
                });
            },

            updateControlState() {
                // Update stop all button
                const stopAllButton = document.querySelector('.action-button.stop-all');
                stopAllButton.disabled = Object.keys(AppState.audio.oscillators).length === 0;

                // Update unpin all button
                const unpinAllButton = document.querySelector('.action-button.unpin-all');
                const hasPinnedItems = Object.values(AppState.frequencies.pinned)
                    .some(arr => arr.length > 0);
                unpinAllButton.disabled = !hasPinnedItems;

                this.renderActiveTones();
            },

            renderActiveTones() {
                const container = document.querySelector('.active-tones-container');
                container.innerHTML = '';

                Object.entries(AppState.audio.oscillators).forEach(([id]) => {
                    const [type, freq] = id.split('-');
                    const frequency = FrequencySystem.getFrequency(id, type);
                    if (!frequency) return;

                    const toneElement = document.createElement('div');
                    toneElement.className = `active-tone active-tone--${type}`;
                    toneElement.innerHTML = `
                        <span class="active-tone__name">${frequency.title}</span>
                        <span class="active-tone__freq">${AudioSystem.formatFrequency(frequency.frequency)}</span>
                        <button class="active-tone__stop" aria-label="Stop ${frequency.title}">×</button>
                    `;

                    toneElement.querySelector('.active-tone__stop').addEventListener('click', () => {
                        AudioSystem.stopTone(id);
                    });

                    container.appendChild(toneElement);
                });
            },

            render() {
                const mainContent = document.querySelector('.frequency-sections');
                mainContent.innerHTML = ''; // Clear existing content

                // First render pinned frequencies if any exist
                const pinnedFreqs = FrequencySystem.getPinnedFrequencies();
                const hasPinnedFreqs = Object.values(pinnedFreqs).some(arr => arr.length > 0);
                
                if (hasPinnedFreqs) {
                    const pinnedSection = this.createSection({
                        title: 'Pinned Frequencies',
                        description: 'Your saved frequencies for quick access',
                        frequencies: Object.values(pinnedFreqs).flat()
                    });
                    mainContent.appendChild(pinnedSection);
                }

                // Render each frequency type section
                ['focus', 'meditation', 'sleep', 'relaxation', 'healing'].forEach(type => {
                    let frequencies = FrequencySystem.getFrequencies(type);
                    
                    // Apply search filter if exists
                    if (AppState.frequencies.filter) {
                        const query = AppState.frequencies.filter.toLowerCase();
                        frequencies = frequencies.filter(freq => 
                            freq.title.toLowerCase().includes(query) ||
                            freq.description.toLowerCase().includes(query) ||
                            freq.frequency.toString().includes(query)
                        );
                    }

                    if (frequencies.length === 0) return; // Skip empty sections

                    const sectionTitle = type.charAt(0).toUpperCase() + type.slice(1);
                    const section = this.createSection({
                        title: `${sectionTitle} Frequencies`,
                        description: this.getSectionDescription(type),
                        frequencies
                    });
                    mainContent.appendChild(section);
                });

                // Update control bar state
                this.updateControlState();
            },

            createSection({ title, description, frequencies }) {
                const section = document.createElement('section');
                section.className = 'frequency-section';
                
                section.innerHTML = `
                    <div class="frequency-section__header">
                        <h2 class="frequency-section__title">${title}</h2>
                        ${description ? `<p class="frequency-section__description">${description}</p>` : ''}
                    </div>
                    <div class="frequency-${AppState.ui.view === 'cards' ? 'grid' : 'list'}">
                        ${frequencies.map(freq => 
                            AppState.ui.view === 'cards' 
                                ? this.createFrequencyCard(freq) 
                                : this.createFrequencyListItem(freq)
                        ).join('')}
                    </div>
                `;

                // Add event listeners to the frequency items
                section.querySelectorAll('.btn--play').forEach(button => {
                    button.addEventListener('click', () => {
                        const { id, type } = button.dataset;
                        const isPlaying = button.classList.contains('playing');
                        
                        if (isPlaying) {
                            AudioSystem.stopTone(id);
                            button.classList.remove('playing');
                            button.innerHTML = `<span class="visually-hidden">Play</span>▶`;
                        } else {
                            const freq = FrequencySystem.getFrequency(id, type);
                            const success = AudioSystem.startTone(id, freq.frequency, {
                                isBinaural: type === 'binaural',
                                carrierFrequency: freq.carrierFrequency
                            });
                            
                            if (success) {
                                button.classList.add('playing');
                                button.innerHTML = `<span class="visually-hidden">Stop</span>⏹`;
                            }
                        }
                    });
                });

                section.querySelectorAll('.btn--pin').forEach(button => {
                    button.addEventListener('click', () => {
                        const { id, type } = button.dataset;
                        const isPinned = button.classList.contains('pinned');
                        
                        if (isPinned) {
                            EventSystem.emit('frequencyUnpinned', { id, type });
                        } else {
                            EventSystem.emit('frequencyPinned', { id, type });
                        }
                    });
                });

                return section;
            },

            createFrequencyCard(freq) {
                const isPinned = AppState.frequencies.pinned[freq.type]?.includes(freq.id);
                const isPlaying = !!AppState.audio.oscillators[freq.id];
                const categoryInfo = FrequencySystem.getCategoryInfo(freq.category);

                return `
                    <article class="frequency-card" data-type="${freq.type}">
                        <header class="frequency-card__header">
                            <h3 class="frequency-card__title">${freq.title}</h3>
                            <span class="frequency-card__frequency">${AudioSystem.formatFrequency(freq.frequency)}</span>
                        </header>
                        <div class="frequency-card__body">
                            <p class="frequency-card__description">${freq.description}</p>
                            ${categoryInfo ? `
                                <span class="category-badge">
                                    ${categoryInfo.name} (${categoryInfo.range})
                                </span>
                            ` : ''}
                            ${freq.warning ? `
                                <p class="frequency-card__warning">⚠️ ${freq.warning}</p>
                            ` : ''}
                            <div class="frequency-card__actions">
                                <button class="btn btn--play ${isPlaying ? 'playing' : ''}"
                                    data-id="${freq.id}"
                                    data-type="${freq.type}">
                                    <span class="visually-hidden">${isPlaying ? 'Stop' : 'Play'}</span>
                                    ${isPlaying ? '⏹' : '▶'}
                                </button>
                                <button class="btn btn--pin ${isPinned ? 'pinned' : ''}"
                                    data-id="${freq.id}"
                                    data-type="${freq.type}">
                                    <span class="visually-hidden">${isPinned ? 'Unpin' : 'Pin'}</span>
                                    ${isPinned ? '📍' : '📌'}
                                </button>
                            </div>
                        </div>
                    </article>
                `;
            },

            createFrequencyListItem(freq) {
                const isPinned = AppState.frequencies.pinned[freq.type]?.includes(freq.id);
                const isPlaying = !!AppState.audio.oscillators[freq.id];
                const categoryInfo = FrequencySystem.getCategoryInfo(freq.category);

                return `
                    <article class="frequency-item" data-type="${freq.type}">
                        <header class="frequency-item__header">
                            <h3 class="frequency-item__title">${freq.title}</h3>
                            <span class="frequency-item__frequency">${AudioSystem.formatFrequency(freq.frequency)}</span>
                            ${categoryInfo ? `
                                <span class="category-badge">
                                    ${categoryInfo.name}
                                </span>
                            ` : ''}
                        </header>
                        <div class="frequency-item__body">
                            <p class="frequency-item__description">
                                ${freq.description}
                                ${freq.warning ? `⚠️ ${freq.warning}` : ''}
                            </p>
                        </div>
                        <div class="frequency-item__actions">
                            <button class="btn btn--play ${isPlaying ? 'playing' : ''}"
                                data-id="${freq.id}"
                                data-type="${freq.type}">
                                <span class="visually-hidden">${isPlaying ? 'Stop' : 'Play'}</span>
                                ${isPlaying ? '⏹' : '▶'}
                            </button>
                            <button class="btn btn--pin ${isPinned ? 'pinned' : ''}"
                                data-id="${freq.id}"
                                data-type="${freq.type}">
                                <span class="visually-hidden">${isPinned ? 'Unpin' : 'Pin'}</span>
                                ${isPinned ? '📍' : '📌'}
                            </button>
                        </div>
                    </article>
                `;
            },

            getSectionDescription(type) {
                const descriptions = {
                    focus: 'Enhance concentration, mental clarity, and cognitive performance for your most important work.',
                    meditation: 'Access deeper states of awareness, creativity, and inner peace with these consciousness-expanding frequencies.',
                    sleep: 'Improve your sleep quality with frequencies that guide your brain into natural sleep patterns.',
                    relaxation: 'Find balance between relaxation and alertness, perfect for unwinding while staying present.',
                    healing: 'Traditional frequencies associated with physical, emotional, and spiritual wellbeing.'
                };
                return descriptions[type] || '';
            }
        };

        // Initialize Core Systems
        document.addEventListener('DOMContentLoaded', () => {
            ThemeSystem.init();
            FrequencySystem.init();
            UISystem.init();
            
            // Setup audio initialization on first user interaction
            const initAudio = async () => {
                try {
                    if (AudioSystem.init()) {
                        document.removeEventListener('click', initAudio);
                        document.removeEventListener('touchstart', initAudio);
                        EventSystem.emit('audioReady');
                    }
                } catch (error) {
                    console.error('Error initializing audio:', error);
                }
            };
            
            // Listen for user interactions that can initialize audio
            document.addEventListener('click', initAudio);
            document.addEventListener('touchstart', initAudio);
            
            // Emit ready event
            EventSystem.emit('appReady');

            // Info modal functionality
            const infoModal = document.getElementById('infoModal');
            const showInfoBtn = document.getElementById('showInfo');
            const closeInfoBtn = document.getElementById('closeInfo');

            // Theme toggle
            const themeToggleBtn = document.getElementById('themeToggle');
            themeToggleBtn.addEventListener('click', () => {
                ThemeSystem.toggleTheme();
                themeToggleBtn.querySelector('.theme-toggle-icon').textContent = 
                    AppState.ui.theme === 'light' ? '🌙' : '☀️';
            });
            // Set initial icon
            themeToggleBtn.querySelector('.theme-toggle-icon').textContent = 
                AppState.ui.theme === 'light' ? '☀️' : '🌙';

            // View toggle
            const viewButtons = document.querySelectorAll('.view-toggle-button');
            viewButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const view = button.dataset.view;
                    AppState.ui.view = view;
                    localStorage.setItem('view', view);
                    
                    // Update button states
                    viewButtons.forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.view === view);
                    });
                    
                    UISystem.render();
                    EventSystem.emit('viewChanged', view);
                });
            });

            showInfoBtn.addEventListener('click', () => {
                infoModal.classList.add('visible');
            });

            closeInfoBtn.addEventListener('click', () => {
                infoModal.classList.remove('visible');
            });

            // Close modal on outside click
            infoModal.addEventListener('click', (e) => {
                if (e.target === infoModal) {
                    infoModal.classList.remove('visible');
                }
            });

            // Close modal on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && infoModal.classList.contains('visible')) {
                    infoModal.classList.remove('visible');
                }
            });
        });
    </script>
</body>
</html> 